\subsection{CÁC PHƯƠNG THỨC TRUYỀN THÔNG}

% Slide 1: Tổng quan
\begin{frame}
\frametitle{Các Giao Thức Truyền Thông trong Hệ Thống Cảnh Báo IoT}
\begin{center}
\Large Hệ thống phát hiện ngã với ba giao thức chính.
\end{center}

\begin{itemize}
\item \textbf{SIP}: Truyền tải âm thanh/video cảnh báo thời gian thực
\item \textbf{MQTT}: Vận chuyển dữ liệu cảm biến từ thiết bị IoT
\item \textbf{JSON}: Định dạng cấu trúc dữ liệu trao đổi
\end{itemize}

\begin{block}{Mục tiêu}
Xây dựng hệ thống cảnh báo không gián đoạn, độ trễ thấp từ cảm biến đến cuộc gọi VoIP
\end{block}
\end{frame}

% SIP
\begin{frame}
\frametitle{Giao thức SIP - Khởi tạo Phiên}
\textbf{Chức năng chính:}
\begin{itemize}
\item Thiết lập cuộc gọi VoIP từ hệ thống cảnh báo
\item Kết nối với Asterisk PBX để gọi điện thoại
\item Truyền âm thanh cảnh báo qua RTP
\end{itemize}

\textbf{Các bước hoạt động:}
\begin{enumerate}
\item REGISTER: Đăng ký thiết bị với server
\item INVITE: Khởi tạo cuộc gọi cảnh báo
\item ACK: Xác nhận kết nối thành công
\item RTP: Truyền dữ liệu âm thanh
\item BYE: Kết thúc cuộc gọi
\end{enumerate}
\end{frame}

\begin{frame}
\frametitle{Phân biệt Đường tín hiệu và Đường truyền phương tiện trong SIP}

\begin{block}{Đường tín hiệu (Signaling Path)}
\begin{itemize}
\item Mang các tin nhắn SIP (INVITE, BYE, 200 OK, v.v.)
\item Thiết lập, quản lý và kết thúc cuộc gọi
\item Sử dụng TCP hoặc UDP
\end{itemize}
\end{block}

\begin{block}{Đường truyền phương tiện (Media Path)}
\begin{itemize}
\item Mang dữ liệu thoại/video thực tế
\item Sử dụng RTP qua UDP
\item Truyền trực tiếp giữa các điểm cuối
\end{itemize}
\end{block}

\end{frame}

\begin{frame}
\frametitle{Sơ đồ Đường tín hiệu và Đường truyền phương tiện}

\begin{figure}[h]
\centering
\begin{tikzpicture}[
    box/.style={rectangle, draw, rounded corners, minimum height=1em, minimum width=2.5em, align=center, fill=blue!10},
    signal_arrow/.style={-Stealth, thick, blue!70!white, shorten >=1pt, shorten <=1pt},
    media_arrow/.style={-Stealth, thick, red!70!white, shorten >=1pt, shorten <=1pt},
    label_style/.style={font=\tiny, align=center, text=black},
    node distance=1.8cm and 2.5cm
]
    % Các Node
    \node[box] (A) {SIP Endpoint A};
    \node[box, right=of A] (Proxy) {SIP Proxy/PBX};
    \node[box, right=of Proxy] (B) {SIP Endpoint B};
    \node[box, below=1.5cm of Proxy] (MediaProxy) {Media Proxy};

    % Đường tín hiệu
    \draw[signal_arrow] (A) -- node[above=1pt, label_style] {SIP (TCP/UDP)} (Proxy);
    \draw[signal_arrow] (Proxy) -- node[above=1pt, label_style] {SIP (TCP/UDP)} (B);

    % Đường truyền phương tiện
    \draw[media_arrow] (A) -- node[midway, left=1pt, label_style] {RTP (UDP)} (MediaProxy);
    \draw[media_arrow] (MediaProxy) -- node[midway, right=1pt, label_style] {RTP (UDP)} (B);
\end{tikzpicture}
\end{figure}

\end{frame}

\begin{frame}
\frametitle{Giao thức ICE (Interactive Connectivity Establishment)}

\begin{block}{Vấn đề}
Các thiết bị thường nằm sau NAT/firewall, ngăn cản truyền dữ liệu RTP trực tiếp
\end{block}

\begin{block}{Giải pháp ICE}
\begin{itemize}
\item \textbf{Local IP:} Địa chỉ IP nội bộ của thiết bị
\item \textbf{STUN:} Phát hiện địa chỉ IP công cộng và cổng NAT
\item \textbf{TURN:} Máy chủ chuyển tiếp khi STUN thất bại
\end{itemize}
\end{block}

\end{frame}

\begin{frame}
\frametitle{SIP trong phần mềm mã nguồn mở Asterisk}

\begin{block}{Lợi ích}
\begin{itemize}
\item \textbf{Quản lý tập trung:} Đồng nhất cấu hình và quản lý thiết bị
\item \textbf{Tương thích cao:} Hỗ trợ đa dạng nền tảng và thiết bị
\item \textbf{Chuẩn mở:} Tích hợp dễ dàng với hạ tầng hiện có
\item \textbf{Bảo mật:} Hỗ trợ TLS (SIP) và SRTP (RTP)
\end{itemize}
\end{block}

\begin{block}{Vai trò của Asterisk}
Đóng vai trò như SIP server, xử lý đăng ký và định tuyến cuộc gọi
\end{block}

\end{frame}

\begin{frame}
\frametitle{Tích Hợp SMS qua SIP}
\begin{block}{Cấu hình}
\begin{itemize}
\item Kích hoạt \texttt{textsupport=yes} trong \texttt{sip.conf}
\item Định nghĩa logic xử lý trong \texttt{extensions.conf}
\end{itemize}
\end{block}

\begin{block}{Thực hiện}
\begin{itemize}
\item Sử dụng lệnh \texttt{MessageSend}
\item Gửi tin nhắn SIP MESSAGE
\item Tích hợp SMS gateway để chuyển tiếp sang mạng di động
\end{itemize}
\end{block}

\end{frame}

% MQTT
\begin{frame}
\frametitle{Giao thức MQTT - Tổng quan}

\begin{block}{Định nghĩa MQTT}
\begin{itemize}
\item MQTT = Message Queuing Telemetry Transport
\item Giao thức nhẹ, tối ưu cho IoT và M2M
\item Hoạt động trên TCP/IP với cơ chế kết nối lâu dài
\end{itemize}
\end{block}

\begin{block}{Đặc điểm MQTT}
\begin{itemize}
\item Thiết kế cho thiết bị có tài nguyên hạn chế
\item Phù hợp với băng thông thấp, kết nối không ổn định
\item Tiêu chuẩn OASIS cho IoT messaging
\end{itemize}
\end{block}

\end{frame}

\begin{frame}
\frametitle{Kiến trúc Publish/Subscribe của MQTT}

\begin{figure}[h]
\centering
\begin{tikzpicture}[
    broker/.style={rectangle, draw, rounded corners, minimum height=2em, minimum width=3em, align=center, fill=green!20},
    client/.style={rectangle, draw, rounded corners, minimum height=1.5em, minimum width=2.5em, align=center, fill=blue!10},
    pub_arrow/.style={-Stealth, thick, orange!70!white, shorten >=1pt, shorten <=1pt},
    sub_arrow/.style={-Stealth, thick, purple!70!white, shorten >=1pt, shorten <=1pt},
    label_style/.style={font=\tiny, align=center, text=black},
    node distance=2cm
]
    % Broker trung tâm
    \node[broker] (broker) {MQTT Broker \\ (Mosquitto/HiveMQ)};

    % Publishers
    \node[client, above left=of broker] (pub1) {Publisher 1};
    \node[client, left=of broker] (pub2) {Publisher 2};

    % Subscribers
    \node[client, above right=of broker] (sub1) {Subscriber 1};
    \node[client, right=of broker] (sub2) {Subscriber 2};
    \node[client, below right=of broker] (sub3) {Subscriber 3};

    % Publish arrows
    \draw[pub_arrow] (pub1) -- node[above left, label_style] {PUBLISH \\ topic/data} (broker);
    \draw[pub_arrow] (pub2) -- node[left, label_style] {PUBLISH} (broker);

    % Subscribe arrows
    \draw[sub_arrow] (broker) -- node[above right, label_style] {SUBSCRIBE \\ topic} (sub1);
    \draw[sub_arrow] (broker) -- node[right, label_style] {MESSAGE} (sub2);
    \draw[sub_arrow] (broker) -- node[below right, label_style] {MESSAGE} (sub3);
\end{tikzpicture}
\end{figure}

\end{frame}

\begin{frame}
\frametitle{Lợi ích của mô hình Publish/Subscribe}

\begin{table}[h]
\centering
\begin{tabular}{ll}
\toprule
Tách rời & Lợi ích \\
\midrule
Không gian & Publisher và Subscriber không cần biết địa chỉ IP của nhau, giao tiếp qua broker \\
Thời gian & Không yêu cầu kết nối đồng thời, hỗ trợ retained messages và clean session \\
Đồng bộ & Truyền/nhận độc lập, giảm độ trễ và tăng hiệu suất \\
\bottomrule
\end{tabular}
\end{table}

\end{frame}

\begin{frame}
\frametitle{Quality of Service (QoS)}

\begin{table}[h]
\centering
\begin{tabular}{lll}
\toprule
Mức & Đặc điểm & Ứng dụng \\
\midrule
QoS 0 & "Fire and forget", nhanh nhưng có thể mất message & Dữ liệu cảm biến thường xuyên \\
QoS 1 & Đảm bảo gửi ít nhất một lần, có thể trùng lặp & Cân bằng độ tin cậy và hiệu suất \\
QoS 2 & Đảm bảo gửi đúng một lần, tin cậy nhất nhưng chậm & Dữ liệu quan trọng \\
\bottomrule
\end{tabular}
\end{table}

\end{frame}

\begin{frame}
\frametitle{Bảo mật trong MQTT}

\begin{block}{Mã hóa Transport Layer}
\begin{itemize}
\item Hỗ trợ TLS/SSL cho kết nối bảo mật
\item MQTT over TLS (port 8883)
\item Bảo vệ dữ liệu trong quá trình truyền
\end{itemize}
\end{block}

\begin{block}{Xác thực và Ủy quyền}
\begin{itemize}
\item Username/Password authentication
\item Client certificates cho xác thực mạnh
\item Access Control Lists (ACL) kiểm soát quyền truy cập topic
\end{itemize}
\end{block}
\end{frame}

\begin{frame}
\frametitle{Các lệnh MQTT chính}

\begin{block}{Connection Management}
\begin{itemize}
\item \texttt{CONNECT/CONNACK}: Khởi tạo và xác nhận kết nối
\item \texttt{DISCONNECT}: Ngắt kết nối graceful
\end{itemize}
\end{block}

\begin{block}{Messaging Operations}
\begin{itemize}
\item \texttt{PUBLISH}: Gửi message tới topic
\item \texttt{PUBACK/PUBREC/PUBREL/PUBCOMP}: QoS acknowledgments
\item \texttt{SUBSCRIBE/SUBACK}: Đăng ký và xác nhận topic
\item \texttt{UNSUBSCRIBE}: Hủy đăng ký topic
\end{itemize}
\end{block}

\begin{block}{Keep Alive}
\texttt{PINGREQ/PINGRESP}: Duy trì kết nối
\end{block}

\end{frame}

\begin{frame}
\frametitle{MQTT trong Hệ thống IoT và Cảnh báo}

\begin{block}{Ứng dụng trong IoT}
\begin{itemize}
\item Thu thập dữ liệu sensors, điều khiển thiết bị
\item Giám sát hệ thống, gửi thông báo
\end{itemize}
\end{block}

\begin{block}{Lợi ích cho hệ thống cảnh báo}
\begin{itemize}
\item Kết nối đáng tin cậy, truyền real-time
\item Hỗ trợ offline messaging, scale tốt
\end{itemize}
\end{block}

\end{frame}

\begin{frame}
\frametitle{Giao thức MQTT - Truyền Dữ Liệu Cảm Biến}

\textbf{Đặc điểm:}
\begin{itemize}
\item Nhẹ, tiết kiệm băng thông cho IoT
\item Mô hình Publish/Subscribe qua Broker
\item Hỗ trợ 3 mức QoS đảm bảo độ tin cậy
\end{itemize}

\textbf{Ví dụ topic:} \texttt{sensor/room/temperature}, \texttt{alert/fall/detected}
\end{frame}

% JSON
\begin{frame}
\frametitle{JSON - JavaScript Object Notation}

\begin{block}{Định nghĩa và Đặc điểm}
\begin{itemize}
\item Định dạng dữ liệu nhẹ, dễ đọc, độc lập ngôn ngữ
\item Cấu trúc cặp \texttt{key:value}, dùng cho trao đổi dữ liệu
\item Phổ biến trong IoT cho lưu trữ và truyền
\end{itemize}
\end{block}

\end{frame}

\begin{frame}[fragile]
\frametitle{Cấu trúc JSON cơ bản}

\begin{block}{Cấu trúc dữ liệu}
\begin{itemize}
\item \textbf{Object}: \texttt{\{key: value\}}
\item \textbf{Array}: \texttt{[value1, value2]}
\item \textbf{Kiểu giá trị}: String, Number, Boolean, null, Object, Array
\end{itemize}
\end{block}

\begin{exampleblock}{Ví dụ JSON}
\begin{minted}[frame=single, linenos, breaklines, fontsize=\footnotesize]{json}
{
  "device_id": "ESP32_001",
  "temperature": 25.5,
  "sensors": ["temp", "light"]
}
\end{minted}
\end{exampleblock}
\end{frame}

\begin{frame}
\frametitle{Ứng dụng JSON trong IoT}

\begin{block}{Lưu cấu hình và Trao đổi dữ liệu}
\begin{itemize}
\item Cấu hình thiết bị (Wi-Fi, MQTT), thông số cảm biến
\item Định dạng payload cho MQTT, API, gửi cảnh báo
\end{itemize}
\end{block}

\end{frame}

\begin{frame}[fragile]
\frametitle{Ví dụ: Cấu hình ESP32 và Payload MQTT}
\begin{minted}[frame=single, linenos, breaklines, fontsize=\footnotesize]{json}
{
  "network": {
    "ssid": "IoT_Network",
    "mqtt_broker": "192.168.1.100"
  },
  "alert": {
    "fall_detected": true,
    "timestamp": "2025-09-17T12:00:00"
  }
}
\end{minted}
\end{frame}

\begin{frame}
\frametitle{Một số Thư viện JSON cho hệ thống nhúng}

\begin{block}{json-c và FirebaseJson}
\begin{itemize}
\item json-c: Phân tích cú pháp, tạo JSON cho C/C++
\item FirebaseJson: Dễ dùng, hỗ trợ JSON phức tạp cho IoT
\end{itemize}
\end{block}

\end{frame}

\begin{frame}
\frametitle{JSON trong MQTT và SIP}

\begin{block}{Tích hợp}
\begin{itemize}
\item Payload JSON trong MQTT topic \texttt{sensor/data}
\item Dữ liệu JSON trong SIP MESSAGE hoặc custom headers
\item Đảm bảo tương tác giữa các giao thức IoT
\end{itemize}
\end{block}

\end{frame}

% Tích hợp
\begin{frame}
\frametitle{JSON và Tích Hợp Hệ Thống}

\textbf{Vai trò JSON:}
\begin{itemize}
\item Định dạng nhẹ, tương thích, tối ưu payload
\end{itemize}

\textbf{Luồng tích hợp:}
\begin{figure}[h]
\centering
\begin{tikzpicture}[
    box/.style={rectangle, draw, rounded corners, minimum height=1em, minimum width=2.5em, align=center, fill=blue!10},
    arrow/.style={-Stealth, thick, shorten >=1pt, shorten <=1pt},
    node distance=1.5cm
]
    \node[box] (sensor) {ESP32};
    \node[box, right=of sensor] (mqtt) {MQTT Broker};
    \node[box, right=of mqtt] (app) {Ứng dụng};
    \node[box, right=of app] (sip) {SIP Server};
    \node[box, right=of sip] (phone) {Điện thoại};

    \draw[arrow] (sensor) -- node[above, font=\tiny] {JSON Payload} (mqtt);
    \draw[arrow] (mqtt) -- node[above, font=\tiny] {Publish} (app);
    \draw[arrow] (app) -- node[above, font=\tiny] {SIP INVITE} (sip);
    \draw[arrow] (sip) -- node[above, font=\tiny] {RTP} (phone);
\end{tikzpicture}
\caption{Luồng dữ liệu từ cảm biến đến cảnh báo}
\end{figure}
\end{frame}

% Kết luận
\begin{frame}
\frametitle{Kết Luận và Tối Ưu Hóa}

\textbf{Lợi ích kết hợp:}
\begin{itemize}
\item MQTT: Thu thập dữ liệu hiệu quả
\item JSON: Cấu trúc linh hoạt
\item SIP: Cảnh báo âm thanh tức thì
\end{itemize}

\textbf{Tối ưu:}
\begin{itemize}
\item Payload JSON nhỏ gọn
\item QoS MQTT phù hợp
\item Tự động reconnect
\item Bảo mật TLS
\end{itemize}

\end{frame}
